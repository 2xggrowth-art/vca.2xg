# Content ID Duplicate Issue - Analysis & Solution

## Problem Identified

You discovered that **two different scripts have the same content_id: `BCH-1001`**

```
BCH-1001 üü° PENDING
Submitted 16/01/2026, 16:41:16
"Have you ever heard of a bicycle cafe..."
By: Prajna

BCH-1001 üü° PENDING
Submitted 18/01/2026, 02:26:58
"About the cycle"
By: Arsalan
```

This is a **critical data integrity issue** because:
1. ‚ùå Search by content_id returns multiple results (confusing)
2. ‚ùå Cannot uniquely identify scripts in production pipeline
3. ‚ùå Breaks tracking and reporting
4. ‚ùå May cause data corruption if systems expect unique IDs

## Root Cause Analysis

### Why This Happened

The content_id is supposed to be auto-generated by a database trigger when a new script is created. The issue occurred due to one or more of these reasons:

1. **Trigger Not Installed**: The `generate_content_id()` trigger may not have been created in the database
2. **Race Condition**: Two scripts created at nearly the same time got the same next_number
3. **Missing Unique Constraint**: No database-level constraint prevents duplicate content_ids
4. **Manual Override**: Someone may have manually set content_id (though unlikely)

### How Content ID Should Work

**Format**: `{INDUSTRY_CODE}-{SEQUENTIAL_NUMBER}`

Examples:
- `BCH-1001` = Bicycle Cafe industry, script #1001
- `GEN-1234` = General industry, script #1234
- `FIT-2001` = Fitness industry, script #2001

**Generation Logic**:
```sql
1. Get industry short_code (e.g., "BCH" for bicycle)
2. Find MAX number for that industry (e.g., BCH-1000 exists)
3. Generate new ID: BCH-1001
4. Assign to new script
```

## The Solution

We've created a comprehensive fix: `FIX-DUPLICATE-CONTENT-IDS.sql`

### What It Does

**Step 1: Identify Duplicates**
```sql
-- Finds all content_ids with COUNT(*) > 1
SELECT content_id, COUNT(*)
FROM viral_analyses
GROUP BY content_id
HAVING COUNT(*) > 1;
```

**Step 2: Fix Existing Duplicates**
- Keeps the **oldest script** with the original content_id (first submission wins)
- Regenerates new unique IDs for **all newer duplicates**
- Ensures no collisions during the fix

Example:
```
Before:
  BCH-1001 (created: 16/01/2026) ‚Üê Keep this
  BCH-1001 (created: 18/01/2026) ‚Üê Change to BCH-1002

After:
  BCH-1001 (created: 16/01/2026) ‚Üê Original kept
  BCH-1002 (created: 18/01/2026) ‚Üê New unique ID
```

**Step 3: Recreate Trigger (Improved)**
- Better race condition handling
- 50 retry attempts before fallback
- Fallback uses timestamp (guaranteed unique)
- Proper error logging

**Step 4: Add Unique Constraint**
```sql
ALTER TABLE viral_analyses
ADD CONSTRAINT viral_analyses_content_id_unique UNIQUE (content_id);
```

This **prevents future duplicates** at the database level. Any attempt to insert a duplicate will fail immediately.

## How to Run the Fix

### Option 1: Via Supabase Dashboard (Recommended)

1. Go to your Supabase project dashboard
2. Navigate to **SQL Editor**
3. Copy the contents of `FIX-DUPLICATE-CONTENT-IDS.sql`
4. Paste and click **Run**
5. Review the output to confirm:
   - ‚úÖ Duplicates were fixed
   - ‚úÖ Trigger was created
   - ‚úÖ Unique constraint was added
   - ‚úÖ Verification shows 0 duplicates

### Option 2: Via Command Line

```bash
# If you have direct PostgreSQL access
psql postgresql://your-connection-string -f FIX-DUPLICATE-CONTENT-IDS.sql
```

## Verification

After running the fix, you should see:

```
CURRENT DUPLICATES:
(empty - no duplicates)

VERIFICATION - REMAINING DUPLICATES:
(empty - all fixed)

TRIGGER VERIFICATION:
trigger_name: auto_generate_content_id
event_manipulation: INSERT
event_object_table: viral_analyses

CONTENT_ID DISTRIBUTION:
industry_prefix | total_scripts | first_id  | last_id
BCH            | 5             | BCH-1001  | BCH-1005
GEN            | 23            | GEN-1001  | GEN-1023
```

## Future Prevention

With this fix applied, duplicates **cannot happen** because:

1. ‚úÖ **Database Trigger**: Auto-generates unique content_ids on INSERT
2. ‚úÖ **Retry Logic**: If collision detected, tries again (up to 50 attempts)
3. ‚úÖ **Timestamp Fallback**: If all retries fail, uses epoch timestamp (always unique)
4. ‚úÖ **Unique Constraint**: Database rejects any duplicate attempts

## Testing the Fix

After applying the fix, test it:

```sql
-- Insert a test script (content_id should auto-generate)
INSERT INTO viral_analyses (
  user_id,
  industry_id,
  hook,
  approval_status
) VALUES (
  'your-user-id',
  'bicycle-industry-id',
  'Test script',
  'PENDING'
) RETURNING content_id;

-- Should return: BCH-1003 (or next available)
```

## Monitoring for Issues

You can periodically check for duplicates:

```sql
-- Run this weekly to ensure no duplicates
SELECT content_id, COUNT(*) as count
FROM viral_analyses
WHERE content_id IS NOT NULL
GROUP BY content_id
HAVING COUNT(*) > 1;

-- Should always return 0 rows
```

## Impact on Existing Data

- ‚úÖ **Prajna's script** (older): Keeps `BCH-1001`
- ‚ö†Ô∏è **Arsalan's script** (newer): Gets new ID like `BCH-1002`

**Important**: After running the fix, update any references to the changed content_ids in:
- Production assignments
- File uploads
- Comments/notes
- External tracking systems

## Questions?

If you encounter any issues:

1. Check if the trigger exists:
```sql
SELECT * FROM information_schema.triggers
WHERE trigger_name = 'auto_generate_content_id';
```

2. Check if unique constraint exists:
```sql
SELECT * FROM pg_constraint
WHERE conname = 'viral_analyses_content_id_unique';
```

3. Test content_id generation manually:
```sql
SELECT generate_content_id() FROM viral_analyses LIMIT 1;
```

---

**Next Steps**: Run `FIX-DUPLICATE-CONTENT-IDS.sql` in your Supabase SQL Editor now to fix the issue permanently.
