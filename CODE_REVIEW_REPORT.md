# Code Review Report - Viral Content Analyzer

**Generated by:** CodeRabbit CLI
**Date:** January 22, 2026
**Project:** ViralContentAnalyzer

---

## Executive Summary

This comprehensive code review identified **15 potential issues** across the codebase, ranging from security concerns to performance optimizations and data integrity issues. The issues are categorized by severity and include actionable recommendations for each.

### Issue Distribution

| Severity | Count |
|----------|-------|
| Critical (Data Integrity/Security) | 4 |
| High (Race Conditions) | 2 |
| Medium (Error Handling/UX) | 6 |
| Low (Code Quality) | 3 |

---

## Critical Issues

### 1. Public File Sharing Security Concern

**File:** `frontend/src/services/googleDriveOAuthService.ts`
**Lines:** 404-410
**Severity:** Critical - Security

**Issue:**
All uploaded files (raw footage, edited videos, final videos) are made publicly accessible via `type: 'anyone'`. Anyone who obtains the file link can view the content without authentication.

**Impact:**
- Sensitive production content could be exposed
- No access control over who views files
- Potential privacy/copyright concerns

**Recommendation:**
```typescript
// Make public sharing configurable per upload
interface UploadOptions {
  shareScope?: 'anyone' | 'domain' | 'private';
  shareWithAdmin?: boolean;
}

async uploadFile(
  file: File,
  folderId: string,
  onProgress?: (progress: UploadProgress) => void,
  options: UploadOptions = { shareScope: 'private', shareWithAdmin: true }
): Promise<UploadResult> {
  // ... upload logic ...

  if (options.shareScope === 'anyone') {
    await this.makeFilePublic(result.fileId);
  } else if (options.shareScope === 'domain') {
    await this.shareDomainOnly(result.fileId);
  }

  if (options.shareWithAdmin && ADMIN_EMAIL) {
    await this.shareFileWithEmail(result.fileId, ADMIN_EMAIL, 'reader');
  }
}
```

---

### 2. Race Condition in Content ID Generation (Migration File 1)

**File:** `supabase/migrations/20250122_content_id_fix.sql`
**Lines:** 43-55
**Severity:** Critical - Data Integrity

**Issue:**
The sequence number is determined by a SELECT, then used in a subsequent UPDATE. Two concurrent transactions can read the same MAX value and generate identical content_id values, violating uniqueness.

**Impact:**
- Duplicate content IDs can be generated
- Data integrity violation
- Confusion in project tracking

**Recommendation:**
```sql
-- Option 1: Use advisory lock
-- Acquire advisory lock based on profile code hash to prevent race
PERFORM pg_advisory_xact_lock(hashtext(v_profile_code));

-- Then proceed with sequence calculation
SELECT COALESCE(MAX(...), 0) + 1 INTO v_sequence_num...

-- Option 2: Add unique constraint with retry logic
ALTER TABLE viral_analyses
ADD CONSTRAINT viral_analyses_content_id_unique UNIQUE (content_id);

-- Then wrap generation in retry loop to handle conflicts
```

---

### 3. Race Condition in Content ID Generation (Migration File 2)

**File:** `supabase/migrations/20250122_content_id_on_approval.sql`
**Lines:** 46-58
**Severity:** Critical - Data Integrity

**Issue:**
Same race condition exists in the approval flow. Concurrent admin approvals for the same profile can generate identical content_ids.

**Recommendation:**
Apply the same advisory lock or unique constraint pattern as above.

---

### 4. Missing Analysis Existence Verification

**File:** `supabase/migrations/20250122_content_id_fix.sql`
**Lines:** 57-62
**Severity:** Critical - Data Integrity

**Issue:**
If `p_analysis_id` doesn't exist or was deleted, the UPDATE affects zero rows, but the function still returns a content_id that wasn't persisted. This causes silent data inconsistency.

**Recommendation:**
```sql
-- Update the analysis with the new content_id
UPDATE viral_analyses
SET content_id = v_content_id
WHERE id = p_analysis_id;

-- Verify the update succeeded
IF NOT FOUND THEN
    RAISE EXCEPTION 'Analysis not found with id: %', p_analysis_id;
END IF;

RETURN v_content_id;
```

---

## High Priority Issues

### 5. Sequence Number Overflow

**File:** `supabase/migrations/20250122_content_id_fix.sql`
**Lines:** 54-55
**Severity:** High

**Issue:**
`LPAD(..., 3, '0')` only pads to 3 characters. When `v_sequence_num` reaches 1000, the result will be "BCHNEX1000" (4 digits), breaking format consistency.

**Recommendation:**
```sql
-- Using 4 digits allows up to 9999 entries per profile
v_content_id := v_profile_code || LPAD(v_sequence_num::TEXT, 4, '0');

-- Or add validation
IF v_sequence_num > 999 THEN
    RAISE EXCEPTION 'Sequence number exceeded maximum (999) for profile: %', v_profile_code;
END IF;
```

---

### 6. Edge Case: Profile Names Without Alphabetic Characters

**File:** `supabase/migrations/20250122_content_id_fix.sql`
**Lines:** 40-41
**Severity:** High

**Issue:**
If `v_profile_name` contains no alphabetic characters (e.g., "123"), `REGEXP_REPLACE` returns an empty string, resulting in a profile code of just "BCH". All such profiles would share the same sequence space.

**Recommendation:**
```sql
v_profile_alpha := UPPER(LEFT(REGEXP_REPLACE(v_profile_name, '[^a-zA-Z]', '', 'g'), 3));

-- Fallback to hash-based code if no alphabetic characters
IF v_profile_alpha = '' THEN
    v_profile_alpha := UPPER(SUBSTRING(md5(v_profile_name) FROM 1 FOR 3));
END IF;

v_profile_code := 'BCH' || v_profile_alpha;
```

---

## Medium Priority Issues

### 7. Inconsistent Cache Invalidation - Bulk Shoot Operations

**File:** `frontend/src/pages/admin/NeedApprovalPage.tsx`
**Lines:** 222-223
**Severity:** Medium

**Issue:**
The `approveShootMutation` invalidates `production-all` and `production-files-all`, but `bulkApproveShootsMutation` does not. This results in stale data when bulk-approving shoots.

**Recommendation:**
```typescript
// In bulkApproveShootsMutation onSuccess
onSuccess: () => {
  queryClient.invalidateQueries({ queryKey: ['admin', 'shoot-reviews'] });
  queryClient.invalidateQueries({ queryKey: ['admin', 'pending-count'] });
  queryClient.invalidateQueries({ queryKey: ['admin', 'production-all'] });      // Add
  queryClient.invalidateQueries({ queryKey: ['admin', 'production-files-all'] }); // Add
  toast.success(`${shootsSelection.selectedCount} shoots approved!`);
  shootsSelection.deselectAll();
},
```

---

### 8. Inconsistent Cache Invalidation - Bulk Edit Operations

**File:** `frontend/src/pages/admin/NeedApprovalPage.tsx`
**Lines:** 245-246
**Severity:** Medium

**Issue:**
Same inconsistency applies to `bulkApproveEditsMutation`.

**Recommendation:**
Apply the same cache invalidation pattern as the shoot operations.

---

### 9. Cross-Origin Download Attribute Limitation

**File:** `frontend/src/components/admin/ProductionDetailPanel.tsx`
**Lines:** 1214-1221
**Severity:** Medium

**Issue:**
The `download` attribute on anchor tags is ignored by browsers when `href` points to a cross-origin URL (e.g., S3, Cloudflare R2). Users clicking "Download" will just open the file in a new tab.

**Recommendation:**
```typescript
// Add a download handler function
const handleDownload = async (fileUrl: string, fileName: string) => {
  try {
    const response = await fetch(fileUrl);
    const blob = await response.blob();
    const url = window.URL.createObjectURL(blob);
    const a = document.createElement('a');
    a.href = url;
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    window.URL.revokeObjectURL(url);
    document.body.removeChild(a);
  } catch (error) {
    toast.error('Failed to download file');
  }
};

// Replace anchor with button
<button
  onClick={() => handleDownload(file.file_url, file.file_name)}
  className="p-1.5 text-gray-600 hover:text-primary-600..."
  title="Download file"
>
  <ArrowDownTrayIcon className="w-4 h-4" />
</button>
```

---

### 10. Draft Cleared Before Submission Confirmation

**File:** `frontend/src/components/wizard/MultiStepAnalysisWizard.tsx`
**Lines:** 178-182
**Severity:** Medium

**Issue:**
If `onSubmit` fails (e.g., network error), the user's draft is already deleted. Users lose their work on submission failure.

**Recommendation:**
```typescript
const handleSubmit = async () => {
  try {
    await onSubmit(analysisData);
    // Only clear draft after successful submission
    clearDraft();
    setHasDraft(false);
  } catch (error) {
    toast.error('Submission failed. Your draft has been preserved.');
    // Draft remains intact for retry
  }
};
```

---

### 11. N+1 Query Performance Issue

**File:** `frontend/src/pages/PostingManagerDashboard.tsx`
**Lines:** 76-89
**Severity:** Medium - Performance

**Issue:**
The `for...of` loop with `await` inside fetches files one analysis at a time, creating a waterfall of sequential HTTP requests. With many projects, this significantly degrades load time.

**Recommendation:**
```typescript
// Parallel fetching
const { data: allProjectFiles = [] } = useQuery({
  queryKey: ['posting-manager', 'all-files', analyses.map(a => a.id).join(',')],
  queryFn: async () => {
    if (analyses.length === 0) return [];

    const filePromises = analyses.map(analysis =>
      productionFilesService.getFiles(analysis.id)
    );
    const results = await Promise.all(filePromises);
    return results.flat();
  },
  enabled: analyses.length > 0,
});

// Better: Add batch endpoint on backend
// productionFilesService.getFilesByAnalysisIds(analyses.map(a => a.id))
```

---

### 12. Missing Error Handling for Tag Inserts

**File:** `frontend/src/components/admin/AdminQuickScriptModal.tsx`
**Lines:** 198-228
**Severity:** Medium

**Issue:**
Steps 3-5 (tag inserts and team assignment) don't check for errors. If these fail, the script is already created but tags may be silently missing, or the mutation fails with a confusing error even though the script was created.

**Recommendation:**
```typescript
// Step 3: Link hook tags
if (data.hookTagIds.length > 0) {
  const hookTagInserts = data.hookTagIds.map(tagId => ({
    analysis_id: analysis.id,
    hook_tag_id: tagId,
  }));
  const { error: hookTagError } = await supabase.from('analysis_hook_tags').insert(hookTagInserts);
  if (hookTagError) console.error('Hook tag linking failed:', hookTagError);
}

// Step 5: Auto-assign team
try {
  await assignmentService.assignTeam(analysis.id, { ... });
} catch (assignError) {
  console.error('Team auto-assignment failed:', assignError);
  // Script created successfully, but team assignment failed - non-blocking
}
```

---

## Low Priority Issues

### 13. Enter Key Can Trigger Submission While Pending

**File:** `frontend/src/components/AssignTeamModal.tsx`
**Lines:** 343-351
**Severity:** Low

**Issue:**
The Add button checks `createProfileMutation.isPending` before allowing submission, but the Enter key handler doesn't. This could lead to duplicate profile creation attempts.

**Recommendation:**
```typescript
onKeyDown={(e) => {
  if (e.key === 'Enter' && newProfileName.trim() && !createProfileMutation.isPending) {
    e.preventDefault();
    createProfileMutation.mutate(newProfileName.trim());
  } else if (e.key === 'Escape') {
    setIsAddingProfile(false);
    setNewProfileName('');
  }
}}
```

---

### 14. Stale Closure Bug in onSuccess Callback

**File:** `frontend/src/components/AssignTeamModal.tsx`
**Lines:** 144-156
**Severity:** Low

**Issue:**
Line 148 uses `formData` directly from the closure, which captures the value at mutation creation time. If `formData` changes while the mutation is in flight, those changes will be overwritten.

**Recommendation:**
```typescript
const createProfileMutation = useMutation({
  mutationFn: (name: string) => contentConfigService.createProfile({ name }),
  onSuccess: (newProfile) => {
    queryClient.invalidateQueries({ queryKey: ['profile-list'] });
    setFormData(prev => ({ ...prev, profileId: newProfile.id })); // Use functional update
    setNewProfileName('');
    setIsAddingProfile(false);
    toast.success(`Profile "${newProfile.name}" created!`);
  },
});
```

---

### 15. UI Shows BCH Selected Even If Auto-Set Failed

**File:** `frontend/src/components/AssignTeamModal.tsx`
**Lines:** 279-286
**Severity:** Low

**Issue:**
The UI unconditionally displays "Bicycle Shop (BCH)" with a success checkmark, regardless of whether `formData.industryId` was actually set.

**Recommendation:**
```tsx
<div className={`bg-blue-50 rounded-lg p-3 border ${
  formData.industryId ? 'border-blue-200' : 'border-red-200 bg-red-50'
}`}>
  <div className={`flex items-center text-sm ${
    formData.industryId ? 'text-blue-700' : 'text-red-700'
  }`}>
    {formData.industryId ? (
      <>
        <CheckCircleIcon className="w-4 h-4 mr-2" />
        <span className="font-medium">Industry:</span>
        <span className="ml-2">Bicycle Shop (BCH)</span>
      </>
    ) : (
      <>
        <ExclamationCircleIcon className="w-4 h-4 mr-2" />
        <span className="font-medium">Industry not found</span>
      </>
    )}
  </div>
</div>
```

---

## Summary of Recommended Actions

### Immediate Actions (Critical)
1. **Add advisory locks or unique constraints** to prevent race conditions in content ID generation
2. **Make public file sharing configurable** to prevent unintended data exposure
3. **Add existence verification** before returning content IDs

### Short-term Actions (High/Medium)
4. **Fix sequence overflow** by using 4-digit padding
5. **Handle edge cases** for profile names without alphabetic characters
6. **Synchronize cache invalidations** between single and bulk operations
7. **Implement proper file download** using fetch/Blob for cross-origin files
8. **Add error handling** for tag inserts and team assignment
9. **Optimize N+1 queries** with parallel fetching or batch endpoints
10. **Preserve drafts** until submission is confirmed successful

### Long-term Improvements (Low)
11. **Fix stale closure bugs** using functional state updates
12. **Add pending guards** to all input handlers
13. **Improve UI feedback** for edge cases (industry not found, etc.)

---

## Testing Recommendations

1. **Concurrency Testing:** Test content ID generation with simultaneous approvals
2. **Load Testing:** Test file upload/download with cross-origin URLs
3. **Error Scenario Testing:** Test form submissions with network failures
4. **Performance Testing:** Measure dashboard load times with 50+ projects

---

*This report was generated using CodeRabbit CLI v0.3.5*
