<!DOCTYPE html>
<html>
<head>
  <title>Supabase Connection Test</title>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>
  <h1>Supabase Connection Test</h1>
  <button onclick="testConnection()">Test Connection</button>
  <button onclick="testAnalyses()">Test Fetch Analyses</button>
  <button onclick="testAsAdmin()">Test As Admin</button>
  <pre id="output"></pre>

  <script>
    // Get your Supabase credentials from .env file
    const SUPABASE_URL = 'YOUR_SUPABASE_URL_HERE';
    const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY_HERE';

    const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
    const output = document.getElementById('output');

    async function testConnection() {
      output.textContent = 'Testing connection...\n';

      try {
        const { data, error } = await supabase.auth.getSession();
        if (error) throw error;

        output.textContent += 'Session: ' + JSON.stringify(data, null, 2) + '\n';

        if (data.session) {
          output.textContent += '\n✓ Logged in as: ' + data.session.user.email;
        } else {
          output.textContent += '\n✗ Not logged in';
        }
      } catch (err) {
        output.textContent += '\n✗ Error: ' + err.message;
      }
    }

    async function testAnalyses() {
      output.textContent = 'Fetching analyses...\n';

      try {
        const { data, error } = await supabase
          .from('viral_analyses')
          .select('*')
          .order('created_at', { ascending: false });

        if (error) throw error;

        output.textContent += '\n✓ Found ' + (data?.length || 0) + ' analyses\n\n';
        output.textContent += JSON.stringify(data, null, 2);
      } catch (err) {
        output.textContent += '\n✗ Error: ' + err.message;
        output.textContent += '\n\n' + JSON.stringify(err, null, 2);
      }
    }

    async function testAsAdmin() {
      output.textContent = 'Testing admin access...\n';

      try {
        // Get current user
        const { data: userData, error: userError } = await supabase.auth.getUser();
        if (userError) throw userError;

        output.textContent += '✓ User ID: ' + userData.user.id + '\n';
        output.textContent += '✓ Email: ' + userData.user.email + '\n\n';

        // Get profile
        const { data: profile, error: profileError } = await supabase
          .from('profiles')
          .select('*')
          .eq('id', userData.user.id)
          .single();

        if (profileError) throw profileError;

        output.textContent += '✓ Role: ' + profile.role + '\n\n';

        // Try to fetch analyses as admin
        const { data: analyses, error: analysesError } = await supabase
          .from('viral_analyses')
          .select(`
            *,
            profiles:user_id (
              email,
              full_name,
              avatar_url
            )
          `)
          .order('created_at', { ascending: false });

        if (analysesError) throw analysesError;

        output.textContent += '✓ Admin can see ' + (analyses?.length || 0) + ' analyses\n\n';
        output.textContent += JSON.stringify(analyses, null, 2);
      } catch (err) {
        output.textContent += '\n✗ Error: ' + err.message;
        output.textContent += '\n\n' + JSON.stringify(err, null, 2);
      }
    }
  </script>
</body>
</html>
